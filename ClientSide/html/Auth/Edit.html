<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Edit My Profile</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
            crossorigin="anonymous"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="../../CSS/Styles.css">
    <link rel="stylesheet" href="../../CSS/Auth.css">

    <!-- SCRIPTS -->
    <script src="../../JS/layout/Header.js"></script>
    <script src="../../JS/Models/User.js"></script>
</head>
<body>

    <!-- Header placeholder -->
    <header></header>

    <div class="auth-container">
        <h1 class="auth-title">Edit My Profile</h1>
        <form id="editProfileForm" class="auth-form">
            <div class="auth-form-group">
                <label for="username" class="auth-label">Username:</label>
                <input type="text" id="username" name="username" class="auth-input" required>
            </div>
            <div class="auth-form-group">
                <label for="email" class="auth-label">Email:</label>
                <input type="email" id="email" name="email" class="auth-input" required>
            </div>
            <div class="auth-form-group">
                <label for="password" class="auth-label">Password:</label>
                <input type="password" id="password" name="password" class="auth-input" required>
            </div>
            <button type="submit" class="auth-btn">Update Profile</button>
        </form>

        <!-- Buttons for additional forms -->
        <div style="text-align: center; margin-top: 20px;">
            <button id="changePasswordBtn" class="modern-button">Change Password</button>
            <button id="changeEmailBtn" class="modern-button">Change Email</button>
            <button id="changeUsernameBtn" class="modern-button">Change Username</button>
        </div>

        <!-- Forms for additional actions -->
        <form id="changePasswordForm" class="auth-form" style="display: none; margin-top: 20px;">
            <h2>Change Password</h2>
            <div class="auth-form-group">
                <label for="currentPassword" class="auth-label">Current Password:</label>
                <input type="password" id="currentPassword" name="currentPassword" class="auth-input" required>
            </div>
            <div class="auth-form-group">
                <label for="newPassword" class="auth-label">New Password:</label>
                <input type="password" id="newPassword" name="newPassword" class="auth-input" required>
            </div>
            <div class="auth-form-group">
                <label for="confirmNewPassword" class="auth-label">Confirm New Password:</label>
                <input type="password" id="confirmNewPassword" name="confirmNewPassword" class="auth-input" required>
            </div>
            <button type="submit" class="auth-btn">Update Password</button>
        </form>

        <form id="changeEmailForm" class="auth-form" style="display: none; margin-top: 20px;">
            <h2>Change Email</h2>
            <div class="auth-form-group">
                <label for="currentPasswordEmail" class="auth-label">Current Password:</label>
                <input type="password" id="currentPasswordEmail" name="currentPasswordEmail" class="auth-input" required>
            </div>
            <div class="auth-form-group">
                <label for="newEmail" class="auth-label">New Email:</label>
                <input type="email" id="newEmail" name="newEmail" class="auth-input" required>
            </div>
            <button type="submit" class="auth-btn">Update Email</button>
        </form>

        <form id="changeUsernameForm" class="auth-form" style="display: none; margin-top: 20px;">
            <h2>Change Username</h2>
            <div class="auth-form-group">
                <label for="currentPasswordUsername" class="auth-label">Current Password:</label>
                <input type="password" id="currentPasswordUsername" name="currentPasswordUsername" class="auth-input" required>
            </div>
            <div class="auth-form-group">
                <label for="newUsername" class="auth-label">New Username:</label>
                <input type="text" id="newUsername" name="newUsername" class="auth-input" required>
            </div>
            <button type="submit" class="auth-btn">Update Username</button>
        </form>
    </div>

    <script>
        $(document).ready(function () {
            const userToken = localStorage.getItem('jwtToken');
            if (!userToken) {
                window.location.href = 'Login.html';
                return;
            }

            // Show/hide forms based on button clicks
            $('#changePasswordBtn').on('click', function () {
                $('.auth-form').hide();
                $('#changePasswordForm').show();
            });

            $('#changeEmailBtn').on('click', function () {
                $('.auth-form').hide();
                $('#changeEmailForm').show();
            });

            $('#changeUsernameBtn').on('click', function () {
                $('.auth-form').hide();
                $('#changeUsernameForm').show();
            });

            // Handle form submissions
            $('#changePasswordForm').on('submit', function (event) {
                event.preventDefault();
                const currentPassword = $('#currentPassword').val();
                const newPassword = $('#newPassword').val();
                const confirmNewPassword = $('#confirmNewPassword').val();

                if (newPassword !== confirmNewPassword) {
                    alert('New passwords do not match.');
                    return;
                }

                const data = { currentPassword, newPassword };
                UserManager.ajaxCall(
                    'PUT',
                    '/api/Users/ChangePassword',
                    JSON.stringify(data),
                    function () {
                        alert('Password updated successfully!');
                        location.reload();
                    },
                    function (error) {
                        alert(error.responseJSON?.message || 'Failed to update password.');
                    }
                );
            });

            $('#changeEmailForm').on('submit', function (event) {
                event.preventDefault();
                const currentPassword = $('#currentPasswordEmail').val();
                const newEmail = $('#newEmail').val();

                const data = { currentPassword, newEmail };
                UserManager.ajaxCall(
                    'PUT',
                    '/api/Users/ChangeEmail',
                    JSON.stringify(data),
                    function () {
                        alert('Email updated successfully!');
                        location.reload();
                    },
                    function (error) {
                        alert(error.responseJSON?.message || 'Failed to update email.');
                    }
                );
            });

            $('#changeUsernameForm').on('submit', function (event) {
                event.preventDefault();
                const currentPassword = $('#currentPasswordUsername').val();
                const newUsername = $('#newUsername').val();

                const data = { currentPassword, newUsername };
                UserManager.ajaxCall(
                    'PUT',
                    '/api/Users/ChangeUsername',
                    JSON.stringify(data),
                    function () {
                        alert('Username updated successfully!');
                        location.reload();
                    },
                    function (error) {
                        alert(error.responseJSON?.message || 'Failed to update username.');
                    }
                );
            });
        });
    </script>

</body>
</html>
