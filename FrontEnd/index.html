<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Movies Cards</title>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="Styles.css">
    
    
        
</head>
<body>
    <header>
        <div class="nav-buttons">
            <button class="nav-button active">Home</button>
            <button class="nav-button" onclick="location.href='MyMovies.html'">My Movies</button>
        </div>
    </header>

    <div class="container">
        <h1>Movies</h1>
        <button id="loadMoviesBtn" class="btn">Load Movies</button>
        <div id="movies-container" class="movie-grid">
            <!-- Movie cards will be appended here -->
        </div>
    </div>

    <!-- Include movies.js which sets up the movies variable -->
    <script src="movies.js"></script>

   <!-- filepath: /c:/Users/GOD/Desktop/repoServerSide/FrontEnd/index.html -->
<script>
        // The AJAX call function as specified
        function ajaxCall(method, api, data, successCB, errorCB) {
            $.ajax({
                type: method, // Get/Post/Put/Delete/Patch
                url: api, // routing to the server
                data: data, // the data we pass in the body (if anyâ€¦)
                cache: false, // allow caching
                contentType: "application/json", // the data format we expect back
                dataType: "json", // the data format that we send 
                //crossDomain: true, 
                success: successCB, // the success callback function
                error: errorCB // the error callback function
            });
        }
        
        // Success callback function
        function onSuccess(data, buttonElement) {
            var messageBox = $('<div>')
            .addClass('message-box')
            .css({
            'padding': '10px',
            'margin': '10px 0',
            'border-radius': '4px',
            'font-size': '14px',
            'color': '#155724',
            'background-color': '#d4edda',
            'border': '1px solid #c3e6cb'
            });

            if (data === false) {
            messageBox
                .text("The movie was not added.")
                .css({
                'color': '#856404',
                'background-color': '#fff3cd',
                'border': '1px solid #ffeeba'
                });
            } else {
            messageBox.text("Success! Movie added.");
            }

            // Insert the message box after the button
            $(buttonElement).after(messageBox);
            setTimeout(() => messageBox.fadeOut(500, () => messageBox.remove()), 3000);
        }
        // Error callback function
        function onError(xhr, status, error) {
            var messageBox = $('<div>')
            .addClass('message-box')
            .css({
                'padding': '10px',
                'margin': '10px 0',
                'border-radius': '4px',
                'font-size': '14px',
                'color': '#721c24',
                'background-color': '#f8d7da',
                'border': '1px solid #f5c6cb'
            })
            .text("Error adding movie: " + status);

            $('body').prepend(messageBox);
            setTimeout(() => messageBox.fadeOut(500, () => messageBox.remove()), 3000);
            console.error(xhr.responseText);
        }
        // Function to add a movie using AJAX
        function addMovieToCollection(movieData,buttonElement) {
            // Ensure ID is an integer
            //movieData.id = parseInt(movieData.id);
            
            // Ensure genres is a string (if it's an array, join it)
            if (Array.isArray(movieData.genres)) {
                movieData.genres = movieData.genres.join(', ');
            }
            
            // Call the AJAX function
            ajaxCall(
                "POST", 
                "https://localhost:7026/api/movies", 
                JSON.stringify(movieData), 
                function(data) {
            // Call onSuccess with both the data and button element
            onSuccess(data, buttonElement);
        },
                onError
            );
        }

        // Button click event to load movies
        $('#loadMoviesBtn').on('click', function () {
            var container = $('#movies-container');
            container.empty(); // Clear any previous content

            // Check if movies variable exists and is an array
            if (typeof movies !== 'undefined' && Array.isArray(movies)) {
                // Loop through each movie and create a card
                $.each(movies, function(index, movie) {
                    // Create the movie card
                    var card = $('<div>').addClass('movie-card');
                    
                    // Image if available
                    if (movie.primaryImage) {
                        var img = $('<img>')
                            .addClass('movie-img')
                            .attr('src', movie.primaryImage)
                            .attr('alt', movie.primaryTitle);
                        card.append(img);
                    }

                    // Card content
                    var content = $('<div>').addClass('movie-content');
                    content.append($('<div>').addClass('movie-title').text(movie.primaryTitle));
                    content.append($('<div>').addClass('movie-info').html('<strong>Year:</strong> ' + (movie.startYear || movie.year || 'N/A')));
                    
                    // Movie description truncated if needed
                    var desc = movie.description ? movie.description.substring(0, 150) + '...' : 'No description available.';
                    content.append($('<div>').addClass('movie-info').html('<strong>Description:</strong> ' + desc));

                    // Movie rating
                    content.append($('<div>').addClass('movie-rating').html('<strong>Rating:</strong> ' + movie.averageRating));

                    // Display genres (if exists as an array, join with commas; if string, display as is)
                    var genresHtml = '';
                    if (Array.isArray(movie.genres)) {
                        genresHtml = movie.genres.join(', ');
                    } else {
                        genresHtml = movie.genres;
                    }
                    content.append($('<div>').addClass('movie-info').html('<strong>Genres:</strong> ' + genresHtml));
                    
                    // Footer with budget, box office and votes
                    var footer = $('<div>').addClass('movie-footer mt-2').html(
                        '<strong>Budget:</strong> $' + Number(movie.budget).toLocaleString() +
                        ' | <strong>Box Office:</strong> $' + Number(movie.grossWorldwide).toLocaleString() +
                        ' | <strong>Votes:</strong> ' + Number(movie.numVotes).toLocaleString()
                    );
                    content.append(footer);
                    
                    // Add "Add Movie" button
                    var addBtn = $('<button>')
                        .addClass('add-movie-btn')
                        .text('Add Movie')
                        .css({
                            'background-color': '#007bff',
                            'color': 'white',
                            'border': 'none',
                            'padding': '8px 15px',
                            'margin-top': '10px',
                            'cursor': 'pointer',
                            'border-radius': '4px'
                        })
                        .click(function() {
                            var clickedButton = $(this);
                            // Create a copy of the movie object for posting
                            var movieToAdd = {
                                id: index+1,
                                url: movie.url || "string",
                                primaryTitle: movie.primaryTitle,
                                description: movie.description || "string",
                                primaryImage: movie.primaryImage || "string",
                                year: movie.year || movie.startYear || 0,
                                releaseDate: movie.releaseDate || "2025-04-07T18:32:37.080Z",
                                language: movie.language || "string",
                                budget: movie.budget || 0,
                                grossWorldwide: movie.grossWorldwide || 0,
                                genres: movie.genres || "string",
                                isAdult: movie.isAdult || false,
                                runtimeMinutes: movie.runtimeMinutes || 0,
                                averageRating: movie.averageRating || 0,
                                numVotes: movie.numVotes || 0
                            };
                            
                            // Call function to add movie
                            addMovieToCollection(movieToAdd,clickedButton);
                        });
                    
                    content.append(addBtn);
                    
                    card.append(content);
                    container.append(card);
                });
            } else {
                container.html('<div style="grid-column: 1/-1; padding: 10px; background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;">No movie data available.</div>');
            }
        });
    </script>
</body>
</html>
