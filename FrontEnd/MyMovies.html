<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Movies Cards</title>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="Styles.css">
    <style>
        .filter-section {
            background-color: #f5f5f5;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .filter-group {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            min-width: 90px;
        }
        
        .filter-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .filter-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }
        
        .search-btn {
            background-color: #28a745;
        }
        
        .reset-btn {
            background-color: #6c757d;
        }
    </style>
</head>
<body>
    <header>
        <div class="nav-buttons">
            <button class="nav-button" onclick="location.href='index.html'">Home</button>
            <button class="nav-button active">My Movies</button>
        </div>
    </header>

    <div class="container">
        <h1>My Movies Collection</h1>
        
        <div class="filter-section">
            <h3>Filter Movies</h3>
            
            <div class="filter-group">
                <label for="title-search">Title:</label>
                <input type="text" id="title-search" placeholder="Search by title...">
                <button class="filter-btn search-btn" id="search-title-btn">Search</button>
            </div>
            
            <div class="filter-group">
                <label for="start-date">Date Range:</label>
                <input type="date" id="start-date" placeholder="Start date">
                <span>to</span>
                <input type="date" id="end-date" placeholder="End date">
                <button class="filter-btn search-btn" id="search-date-btn">Search</button>
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn reset-btn" id="reset-filters-btn">Reset Filters</button>
            </div>
        </div>
        
        <button id="loadMoviesBtn" class="btn">Load All Movies</button>
        <div id="movies-container" class="movie-grid">
            <!-- Movie cards will be appended here -->
        </div>
    </div>

    <script>
        // The AJAX call function as specified
        function ajaxCall(method, api, data, successCB, errorCB) {
            $.ajax({
                type: method, // Get/Post/Put/Delete/Patch
                url: api, // routing to the server
                data: data, // the data we pass in the body (if anyâ€¦)
                cache: false, // allow caching
                contentType: "application/json", // the data format we expect back
                dataType: "json", // the data format that we send 
                success: successCB, // the success callback function
                error: errorCB // the error callback function
            });
        }
        
        // Success callback for GET request
        function onGetSuccess(data) {
            displayMovies(data);
        }
        
        // Success callback for DELETE request
        function onDeleteSuccess(data) {
            alert("Success! Movie deleted.");
            // Reload the movies to refresh the list
            loadMovies();
        }
        
        // Error callback function
        function onError(xhr, status, error) {
            alert("Error: " + status);
            console.error(xhr.responseText);
        }
        
        // Function to delete a movie using AJAX
        function deleteMovie(id) {
            if (confirm("Are you sure you want to delete this movie?")) {
                // Call the AJAX function with DELETE method
                ajaxCall(
                    "DELETE", 
                    "https://localhost:7026/api/movies/" + id, 
                    null, 
                    onDeleteSuccess, 
                    onError
                );
            }
        }

        // Function to load all movies from the server
        function loadMovies() {
            var container = $('#movies-container');
            container.html('<div style="grid-column: 1/-1; text-align: center; padding: 20px;">Loading movies...</div>');
            
            // Get movies from server
            ajaxCall(
                "GET",
                "https://localhost:7026/api/movies",
                null,
                onGetSuccess,
                onError
            );
        }
        
        // Function to search movies by title
        function searchMoviesByTitle(title) {
            var container = $('#movies-container');
            container.html('<div style="grid-column: 1/-1; text-align: center; padding: 20px;">Searching for movies with title "' + title + '"...</div>');
            
            // Get movies by title
            ajaxCall(
            "GET",
            "https://localhost:7026/api/movies/(title)?title=" + title,
            null,
            onGetSuccess,
            onError
            );
        }
        
        // Function to search movies by date range
        function searchMoviesByDateRange(startDate, endDate) {
            var container = $('#movies-container');
            container.html('<div style="grid-column: 1/-1; text-align: center; padding: 20px;">Searching for movies released between ' + startDate + ' and ' + endDate + '...</div>');
            
            // Get movies by date range
            ajaxCall(
                "GET",
                "https://localhost:7026/api/movies/GetByReleaseDate/startDate/" + startDate + "/endDate/" + endDate,
                null,
                onGetSuccess,
                onError
            );
        }
        
        // Function to display movies in cards
        function displayMovies(movies) {
            var container = $('#movies-container');
            container.empty(); // Clear any previous content

            // Check if we have movies to display
            if (movies && movies.length > 0) {
                // Loop through each movie and create a card
                $.each(movies, function(index, movie) {
                    // Create the movie card
                    var card = $('<div>').addClass('movie-card');
                    
                    // Image if available
                    if (movie.primaryImage) {
                        var img = $('<img>')
                            .addClass('movie-img')
                            .attr('src', movie.primaryImage)
                            .attr('alt', movie.primaryTitle);
                        card.append(img);
                    }

                    // Card content
                    var content = $('<div>').addClass('movie-content');
                    content.append($('<div>').addClass('movie-title').text(movie.primaryTitle));
                    content.append($('<div>').addClass('movie-info').html('<strong>Year:</strong> ' + (movie.year || 'N/A')));
                    
                    // Release date (formatted)
                    if (movie.releaseDate) {
                        var date = new Date(movie.releaseDate);
                        var formattedDate = date.toLocaleDateString();
                        content.append($('<div>').addClass('movie-info').html('<strong>Release Date:</strong> ' + formattedDate));
                    }
                    
                    // Movie description truncated if needed
                    var desc = movie.description ? movie.description.substring(0, 150) + '...' : 'No description available.';
                    content.append($('<div>').addClass('movie-info').html('<strong>Description:</strong> ' + desc));

                    // Movie rating
                    content.append($('<div>').addClass('movie-rating').html('<strong>Rating:</strong> ' + movie.averageRating));

                    // Display genres
                    content.append($('<div>').addClass('movie-info').html('<strong>Genres:</strong> ' + (movie.genres || 'Not specified')));
                    
                    // Footer with budget, box office and votes
                    var footer = $('<div>').addClass('movie-footer mt-2').html(
                        '<strong>Budget:</strong> $' + Number(movie.budget).toLocaleString() +
                        ' | <strong>Box Office:</strong> $' + Number(movie.grossWorldwide).toLocaleString() +
                        ' | <strong>Votes:</strong> ' + Number(movie.numVotes).toLocaleString()
                    );
                    content.append(footer);
                    
                    // Add "Delete Movie" button
                    var deleteBtn = $('<button>')
                        .addClass('delete-movie-btn')
                        .text('Delete Movie')
                        .css({
                            'background-color': '#dc3545',
                            'color': 'white',
                            'border': 'none',
                            'padding': '8px 15px',
                            'margin-top': '10px',
                            'cursor': 'pointer',
                            'border-radius': '4px'
                        })
                        .click(function() {
                            deleteMovie(movie.id);
                        });
                    
                    content.append(deleteBtn);
                    
                    card.append(content);
                    container.append(card);
                });
            } else {
                container.html('<div style="grid-column: 1/-1; padding: 10px; background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;">No movies found matching your criteria.</div>');
            }
        }

        // Button click event to load all movies
        $('#loadMoviesBtn').on('click', function() {
            loadMovies();
        });
        
        // Button click event to search by title
        $('#search-title-btn').on('click', function() {
            const title = $('#title-search').val();
            if (title) {
                searchMoviesByTitle(title);
            } else {
                alert('Please enter a title to search');
            }
        });
        
        // Button click event to search by date range
        $('#search-date-btn').on('click', function() {
            const startDate = $('#start-date').val();
            const endDate = $('#end-date').val();
            
            if (startDate && endDate) {
                if (new Date(startDate) > new Date(endDate)) {
                    alert('Start date must be before end date');
                } else {
                    searchMoviesByDateRange(startDate, endDate);
                }
            } else {
                alert('Please select both start and end dates');
            }
        });
        
        // Button click event to reset filters
        $('#reset-filters-btn').on('click', function() {
            $('#title-search').val('');
            $('#start-date').val('');
            $('#end-date').val('');
            loadMovies();
        });
    </script>
</body>
</html>